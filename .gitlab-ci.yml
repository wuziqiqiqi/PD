#image: python:latest
image: python:3.9

before_script:
  - python3 --version
  - python3 -m pip install tox

stages:
  - Static Analysis
  - Code Test
  - Deploy

flake8:
  stage: Static Analysis
  script:
    - tox -e flake8

pylint:
  stage: Static Analysis
  script:
    - python3 -m pip install pylint
    - pylint --disable=all --enable=dangerous-default-value clease/

# mypy:
#   stage: Static Analysis
#   allow_failure: true
#   script:
#     - pip install mypy
#     - pwd
#     - python3 -m mypy clease/

pytest:default:
  stage: Code Test
  coverage: '/TOTAL\s+.*( \d+\%)/'
  script:
    - pwd
    - tox -e cov

doctest:
  stage: Code Test
  script:
    - python3 -m pip install .[doc]
    - apt-get update -qy
    - apt-get install -qy xvfb
    - cd doc
    - make doctest SPHINXOPTS="-W"

pages:
  stage: Deploy
  script:
    - python3 -m pip install .[doc]
    - cd doc
    - make html
    - mv build/html/ ../public/
  artifacts:
    paths:
      - public
  only:
    - master

.test_template: &manual_test
  stage: Code Test
  when: manual

python3_test_slow:
  script:
    - tox -e current -- --runslow --durations=30 tests/
  <<: *manual_test

# Some optional tests for older python versions
pytest:py36:
  image: python:3.6
  <<: *manual_test
  script:
    - tox -e py36

pytest:py37:
  image: python:3.7
  <<: *manual_test
  script:
    - tox -e py37

pytest:py38:
  image: python:3.8
  <<: *manual_test
  script:
    - tox -e py38
